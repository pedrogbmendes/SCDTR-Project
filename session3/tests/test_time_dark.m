s = [0.41
216
0.43
792
0.44
1376
0.48
2008
0.51
2640
0.54
3272
0.73
5680
1.72
18160
2.27
31680
2.46
45200
2.55
58720
2.61
72240
2.64
85760
2.66
99280
2.68
112800
2.69
127360
2.70
141920
2.70
156480
2.72
171040
2.71
185600
2.72
200160
2.72
214720
2.73
229280
2.74
243840
2.73
258400
2.73
272960
2.74
287520
2.75
302080
2.74
316640
2.74
331200
2.74
345760
2.74
360320
2.74
374888
2.75
389440
2.75
404000
2.75
418560
2.75
433120
2.76
447680
2.75
462240
2.75
476800
2.75
491360
2.76
505920
2.75
520480
2.75
535040
2.75
549600
2.75
564160
2.77
578720
2.75
593280
2.75
607840
2.75
622400
2.75
636960
3.09
651520
3.18
666080
3.22
680640
3.23
695200
3.24
709760
3.25
724320
3.24
738880
3.24
753440
3.26
768000
3.26
782560
3.25
797120
3.24
811680
3.25
826240
3.25
840808
3.27
855360
3.25
869920
3.25
884480
3.25
899040
3.26
913600
3.26
928160
3.25
942720
3.25
957280
3.27
971840
3.27
986400
3.25
1000960
3.27
1016560
3.25
1032160
3.27
1047760
3.25
1063360
3.25
1078960
3.26
1094560
3.25
1110160
3.27
1125760
3.25
1141360
3.27
1156960
3.26
1172560
3.25
1188160
3.27
1203760
3.25
1219360
3.27
1234960
3.25
1250560
3.25
1266160
3.27
1281760
3.25
1297360
3.27
1312960
3.25
1328560
3.25
1344160
3.26
1359760
3.25
1375360
3.27
1390960
3.45
1406560
3.50
1422160
3.51
1437760
3.50
1453360
3.52
1468960
3.51
1484560
3.53
1500160
3.51
1515760
3.53
1531360
3.53
1546960
3.51
1562560
3.53
1578160
3.51
1593760
3.53
1609360
3.53
1624960
3.53
1640568
3.53
1656160
3.51
1671760
3.53
1687360
3.53
1702960
3.52
1718560
3.53
1734160
3.51
1749760
3.53
1765364
3.52
1780960
3.52
1796560
3.53
1812160
3.51
1827760
3.53
1843360
3.51
1858960
3.53
1874560
3.53
1890160
3.53
1905768
3.53
1921360
3.51
1936960
3.53
1952560
3.53
1968160
3.52
1983760
3.53
1999360
3.51
2014960
3.53
2030560
3.52
2046160
3.53
2061760
3.53
2077360
3.51
2092960
3.53
2108560
3.52
2124160
3.53
2139760
3.53
2155360
3.53
2170960
3.66
2186560
3.66
2202160
3.69
2217760
3.69
2233360
3.69
2248960
3.69
2264560
3.68
2280160
3.69
2295760
3.69
2311360
3.70
2326960
3.69
2342560
3.68
2358160
3.69
2373760
3.70
2389360
3.69
2404960
3.70
2420560
3.69
2436160
3.69
2451760
3.68
2467360
3.69
2482960
3.70
2498560
3.70
2514160
3.69
2529760
3.68
2545360
3.69
2560960
3.69
2576560
3.70
2592160
3.69
2607760
3.68
2623360
3.70
2638968
3.69
2654560
3.69
2670160
3.69
2685760
3.69
2701360
3.69
2716960
3.68
2732560
3.70
2748160
3.69
2763764
3.69
2779360
3.69
2794960
3.68
2810560
3.69
2826160
3.70
2841760
3.70
2857360
3.69
2872960
3.68
2888560
3.69
2904168
3.69
2919760
3.70
2935360
3.69
2950960
3.81
2966560
3.81
2982160
3.82
2997760
3.82
3013360
3.82
3028960
3.83
3044560
3.82
3060160
3.83
3075760
3.82
3091360
3.82
3106960
3.82
3122560
3.82
3138160
3.83
3153760
3.83
3169360
3.83
3184960
3.83
3200560
3.83
3216160
3.82
3231760
3.82
3247360
3.83
3262960
3.82
3278560
3.82
3294160
3.82
3309760
3.82
3325360
3.83
3340960
3.82
3356560
3.83
3372160
3.82
3387760
3.82
3403360
3.83
3418960
3.82
3434560
3.83
3450160
3.82
3465760
3.83
3481360
3.82
3496960
3.82
3512560
3.82
3528160
3.82
3543760
3.83
3559360
3.82
3574960
3.83
3590560
3.82
3606160
3.83
3621760
3.83
3637368
3.83
3652960
3.82
3668560
3.82
3684160
3.82
3699760
3.83
3715360
3.82
3730960
3.73
3746560
3.70
3762164
3.70
3777760
3.68
3793360
3.70
3808960
3.70
3824560
3.70
3840160
3.69
3855760
3.68
3871360
3.69
3886960
3.68
3902568
3.70
3918160
3.69
3933760
3.68
3949360
3.70
3964960
3.69
3980560
3.70
3996160
3.70
4011760
3.69
4027360
3.69
4042960
3.68
4058560
3.69
4074160
3.69
4089760
3.69
4105360
3.69
4120960
3.68
4136560
3.69
4152160
3.69
4167760
3.70
4183360
3.69
4198960
3.68
4214560
3.69
4230160
3.69
4245760
3.69
4261360
3.69
4276960
3.69
4292560
3.69
4308160
3.68
4323760
3.69
4339360
3.69
4354960
3.69
4370560
3.69
4386160
3.68
4401760
3.69
4417360
3.69
4432960
3.69
4448560
3.69
4464160
3.68
4479760
3.69
4495360
3.69
4510960
3.58
4526560
3.55
4542160
3.52
4557760
3.54
4573360
3.51
4588960
3.53
4604560
3.53
4620160
3.53
4635768
3.53
4651360
3.51
4666960
3.53
4682560
3.52
4698160
3.53
4713760
3.53
4729360
3.51
4744960
3.53
4760564
3.51
4776160
3.53
4791760
3.53
4807360
3.51
4822960
3.53
4838560
3.52
4854160
3.53
4869760
3.53
4885360
3.53
4900968
3.53
4916560
3.51
4932160
3.53
4947760
3.52
4963360
3.52
4978960
3.53
4994560
3.51
5010160
3.53
5025760
3.51
5041360
3.53
5056960
3.53
5072560
3.52
5088160
3.53
5103760
3.51
5119360
3.53
5134960
3.53
5150560
3.52
5166160
3.53
5181760
3.51
5197360
3.53
5212960
3.51
5228560
3.52
5244160
3.53
5259760
3.51
5275360
3.53
5290960
3.34
5306560
3.29
5322160
3.28
5337760
3.27
5353360
3.27
5368960
3.26
5384560
3.27
5400160
3.26
5415760
3.26
5431360
3.27
5446960
3.26
5462560
3.27
5478160
3.26
5493760
3.26
5509360
3.27
5524960
3.25
5540560
3.27
5556160
3.26
5571760
3.25
5587360
3.26
5602960
3.25
5618560
3.26
5634168
3.25
5649760
3.27
5665360
3.25
5680960
3.25
5696560
3.27
5712160
3.26
5727760
3.27
5743360
3.26
5758964
3.26
5774560
3.27
5790160
3.25
5805760
3.27
5821360
3.26
5836960
3.25
5852560
3.26
5868160
3.25
5883760
3.26
5899368
3.26
5914960
3.27
5930560
3.26
5946160
3.26
5961760
3.27
5977360
3.25
5992960
3.27
6008560
3.25
6024160
3.25
6039760
3.27
6055360
3.25
6070960
2.99
6086560
2.87
6102160
2.82
6117760
2.80
6133360
2.79
6148960
2.80
6164560
2.78
6180160
2.78
6195760
2.77
6211360
2.77
6226960
2.79
6242560
2.77
6258160
2.78
6273760
2.77
6289360
2.77
6304960
2.76
6320560
2.76
6336160
2.77
6351760
2.76
6367360
2.76
6382960
2.77
6398560
2.76
6414160
2.78
6429760
2.76
6445360
2.76
6460960
2.76
6476560
2.76
6492160
2.78
6507760
2.76
6523360
2.77
6538960
2.76
6554560
2.76
6570160
2.76
6585760
2.76
6601360
2.77
6616960
2.76
6632568
2.76
6648160
2.76
6663760
2.76
6679360
2.77
6694960
2.76
6710560
2.76
6726160
2.76
6741760
2.76
6757364
2.77
6772960
2.76
6788560
2.77
6804160
2.76
6819760
2.76
6835360];

v = s(1:2:end,:);  % odd matrix

t = s(2:2:end,:);  % even matrix
t = t * 10^(-6);

figure(1);
plot(t,v);



v1 = v(1:50);
v2 = v(51:100);
v3 = v(101:150);
v4 = v(151:200);
v5 = v(201:250);
v6 = v(251:300);
v7 = v(301:350);
v8 = v(351:400);
v9 = v(401:450);

stab1 = mean (v1(30:50));%50
stab2 = mean (v2(30:50));%100
stab3 = mean (v3(30:50));%150
stab4 = mean (v4(30:50));%200
stab5 = mean (v5(30:50));%255
stab6 = mean (v6(30:50));%200
stab7 = mean (v7(30:50));%150
stab8 = mean (v8(30:50));%100
stab9 = mean (v9(30:50));%50

tauy(1) = v1(1) + ( stab1-v1(1) )*0.63; %50
tauy(2) = v2(1) + ( stab2-v2(1) )*0.63; %100
tauy(3) = v3(1) + ( stab3-v3(1) )*0.63; %150
tauy(4) = v4(1) + ( stab4-v4(1) )*0.63; %200
tauy(5) = v5(1) + ( stab5-v5(1) )*0.63; %250
tauy(6) = v6(1) - ( v6(1)-stab6 )*0.37; %200
tauy(7) = v7(1) - ( v7(1)-stab7 )*0.37; %150
tauy(8) = v8(1) - ( v8(1)-stab8 )*0.37; %100
tauy(9) = v9(1) - ( v9(1)-stab9 )*0.37; %50



%50
pt1 = find( v1 <= tauy(1));
pt1 = pt1(end);
m = (v1(pt1+1)-v1(pt1))/(t(pt1+1)-t(pt1));
b = v1(pt1) - m*(t(pt1));
tau(1) = (tauy(1) - b)/m - t(1);

%100
pt1 = find( v2 <= tauy(2));
pt1 = pt1(end);
pt1t = pt1 + 50;
m = (v2(pt1+1)-v2(pt1))/(t(pt1t+1)-t(pt1t));
b = v2(pt1) - m*(t(pt1t));
tau(2) = (tauy(2) - b)/m - t(51);

%150
pt1 = find( v3 <= tauy(3));
pt1 = pt1(end);
pt1t = pt1 + 100;
m = (v3(pt1+1)-v3(pt1))/(t(pt1t+1)-t(pt1t));
b = v3(pt1) - m*(t(pt1t));
tau(3) = (tauy(3) - b)/m - t(101);

%200
pt1 = find( v4 <= tauy(4));
pt1 = pt1(end);
pt1t = pt1 + 150;
m = (v4(pt1+1)-v4(pt1))/(t(pt1t+1)-t(pt1t));
b = v4(pt1) - m*(t(pt1t));
tau(4) = (tauy(4) - b)/m - t(151);

%255
pt1 = find( v5 <= tauy(5));
pt1 = pt1(end);
pt1t = pt1 + 200;
m = (v5(pt1+1)-v5(pt1))/(t(pt1t+1)-t(pt1t));
b = v5(pt1) - m*(t(pt1t));
tau(5) = (tauy(5) - b)/m - t(201);

%200
pt1 = find( v6 >= tauy(6));
pt1 = pt1(end);
pt1t = pt1 + 250;
m = (v6(pt1+1)-v6(pt1))/(t(pt1t+1)-t(pt1t));
b = v6(pt1) - m*(t(pt1t));
tau(6) = (tauy(6) - b)/m - t(251);

%150
pt1 = find( v7 >= tauy(7));
pt1 = pt1(end);
pt1t = pt1 + 300;
m = (v7(pt1+1)-v7(pt1))/(t(pt1t+1)-t(pt1t));
b = v7(pt1) - m*(t(pt1t));
tau(7) = (tauy(7) - b)/m - t(301);

%100
pt1 = find( v8 >= tauy(8));
pt1 = pt1(end);
pt1t = pt1 + 350;
m = (v8(pt1+1)-v8(pt1))/(t(pt1t+1)-t(pt1t));
b = v8(pt1) - m*(t(pt1t));
tau(8) = (tauy(8) - b)/m - t(351);

%50
pt1 = find( v9 >= tauy(9));
pt1 = pt1(end);
pt1t = pt1 + 400;
m = (v9(pt1+1)-v9(pt1))/(t(pt1t+1)-t(pt1t));
b = v9(pt1) - m*(t(pt1t));
tau(9) = (tauy(9) - b)/m - t(401);

disp(tau);

pwm = [50 100 150 200 255];
figure(2);
plot(pwm, tau(1:5),'.');
figure(3);

plot(pwm(1:4), flip(tau(6:9)),'.');
f2 = fit (t(51:100),v2,fittype('a-b*exp(-c*x)'), 'StartPoint',[[ones(size(t(51:100))), -exp(-t(51:100))]\v2; 1]);
f2 = fit (pwm', tau(1:5)','exp1');
figure(2);
hold on;
plot(f2)

m = -0.363;
b = log10(20515.0); 

R_ldr(1) = (5.0-stab1)*(10000/stab1);
i_lux(1) = power(10.0, ((log10(R_ldr(1))-b)/m ));

R_ldr(2) = (5.0-stab2)*(10000/stab2);
i_lux(2) = power(10.0, ((log10(R_ldr(2))-b)/m ));

R_ldr(3) = (5.0-stab3)*(10000/stab3);
i_lux(3) = power(10.0, ((log10(R_ldr(3))-b)/m ));

R_ldr(4) = (5.0-stab4)*(10000/stab4);
i_lux(4) = power(10.0, ((log10(R_ldr(4))-b)/m ));

R_ldr(5) = (5.0-stab5)*(10000/stab5);
i_lux(5) = power(10.0, ((log10(R_ldr(5))-b)/m ));

gain(1) = i_lux(1)/ 50;%50
gain(2) = i_lux(2)/ 100;%100
gain(3) = i_lux(3)/ 150;%150
gain(4) = i_lux(4)/ 200;%200
gain(5) = i_lux(5)/ 250;%255
 
f3 = fit (pwm', i_lux','poly1')
figure(4);

plot(pwm, i_lux,'x');
hold on;
plot(f3);
axis([0 260 0 250]);
